<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JS CSRF Test</title>
</head>
<body>
    <h1>JS CSRF 보호 테스트</h1>
    <p>상태: <span id="status">대기 중...</span></p>
    
    <button id="btnInit">1. CSRF 토큰 받기 (GET)</button>
    <button id="btnPost">2. 데이터 전송 (POST)</button>

    <div id="result" style="margin-top:20px; padding:10px; border:1px solid #ccc;">
        서버 응답이 여기에 표시됩니다.
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const resultEl = document.getElementById('result');

        // 쿠키에서 특정 이름의 값을 가져오는 함수
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // 1. 초기 GET 요청 (서버로부터 XSRF-TOKEN 쿠키를 받아옴)
        document.getElementById('btnInit').onclick = async () => {
            try {
                // credentials: 'include'가 있어야 다른 포트의 쿠키를 허용함
                await fetch('http://localhost:8080/api/init', { credentials: 'include' });
                statusEl.innerText = "쿠키 수신 완료! (개발자 도구 Application 탭 확인)";
            } catch (err) {
                statusEl.innerText = "초기화 실패: " + err.message;
            }
        };

        // 2. POST 요청 (쿠키에서 토큰을 읽어 헤더에 수동으로 담음)
        document.getElementById('btnPost').onclick = async () => {
            const token = getCookie('XSRF-TOKEN'); // 서버가 준 쿠키 읽기

            if (!token) {
                alert("CSRF 토큰이 없습니다. 먼저 1번 버튼을 누르세요.");
                return;
            }

            try {
                const response = await fetch('http://localhost:8080/api/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-XSRF-TOKEN': token // 헤더에 토큰 첨부
                    },
                    body: JSON.stringify({ name: "Vanilla JS User" }),
                    credentials: 'include' // 쿠키 세션 유지를 위해 필수
                });

                const data = await response.text();
                resultEl.innerText = `서버 응답 (${response.status}): ${data}`;
            } catch (err) {
                resultEl.innerText = "에러 발생: " + err.message;
            }
        };
    </script>
</body>
</html>